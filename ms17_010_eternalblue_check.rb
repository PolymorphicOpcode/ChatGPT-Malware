#
#
# Metasploit Module
#
# Name: MS17-010: Check for Windows SMB Remote Code Execution Vulnerability (CVE-2017-0144)
#
# Version: 0.1
#
# Author: ida-bro & davinci
#
# Description:
#
# This module checks a target machine for vulnerability to CVE-2017-0144, a remote code execution vulnerability
# in Microsoft Windows SMB Server.

require 'msf/core'

class MetasploitModule < Msf::Auxiliary
  include Msf::Exploit::Remote::SMB::Client

  def initialize(info = {})
    super(update_info(info,
      'Name'           => 'MS17-010: Check for Windows SMB Remote Code Execution Vulnerability (CVE-2017-0144)',        
      'Description'    => %q{
        This module checks a target machine for vulnerability to CVE-2017-0144, a remote code execution
        vulnerability in Microsoft Windows SMB Server.
      },
      'Author'         => 'Your Name',
      'License'        => MSF_LICENSE
    ))

    register_options([
      OptString.new('RHOST', [true, 'The target address', nil]),
      OptString.new('RPORT', [true, 'The target port', 445]),
      OptString.new('SMBUser', [ true, 'The username to authenticate as', 'Administrator' ])
    ])
  end

  def run
    connect
    smb_login
    check_vuln
  end

  def check_vuln
    begin
      smb_create("\\\x00\\\x00\\\x00\\\x00\\\x00\\\x00\\\x00\\\x00\\\x00\\\x00\\\x00\\\x00\\\x00\\\x00\\\x00\\\x00")    
    rescue Rex::Proto::SMB::Exceptions::ErrorCode => e
      if e.error_code == 'STATUS_INSUFF_SERVER_RESOURCES'
        print_good('The target is vulnerable to CVE-2017-0144')
      else
        print_error('The target is not vulnerable to CVE-2017-0144')
      end
    end
  end
end
